{% extends 'layout.html' %}
{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm p-4">
                <div class="text-center mb-4">
                    <h4 class="fw-bold">{{ establishment.name }}</h4>
                    <h5 class="text-muted">{{ service.name }} - R$ {{ "%.2f"|format(service.price) }}</h5>
                </div>
                <form id="form" method="POST" action="{{ url_for('create_appointment', url_prefix=establishment.url_prefix) }}">
                    <input type="hidden" name="service_id" value="{{ service.id }}">
                    <input type="text" name="client_name" class="form-control mb-2" placeholder="Seu Nome" required>
                    <input type="tel" name="client_phone" class="form-control mb-3" placeholder="Seu Celular" required>
                    
                    <label class="fw-bold small mb-1">Data</label>
                    <input type="date" id="date" name="appointment_date" class="form-control mb-3" required>
                    
                    <label class="fw-bold small mb-1">Horários</label>
                    <div id="slots" class="d-flex flex-wrap gap-2 mb-3">
                        <small class="text-muted w-100 text-center py-2 bg-light rounded">Selecione uma data</small>
                    </div>
                    <input type="hidden" id="time" name="appointment_time" required>
                    
                    <button id="btn" class="btn btn-success w-100 fw-bold" disabled>Confirmar Agendamento</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    const sid = {{ service.id }};
    const dateInp = document.getElementById('date');
    dateInp.min = new Date().toISOString().split('T')[0];
    
    dateInp.addEventListener('change', async (e) => {
        if(!e.target.value) return;
        const slotsDiv = document.getElementById('slots');
        slotsDiv.innerHTML = '<small class="w-100 text-center text-muted">Carregando...</small>';
        
        const res = await fetch(`/api/horarios_disponiveis?service_id=${sid}&date=${e.target.value}`);
        const times = await res.json();
        
        slotsDiv.innerHTML = '';
        if(times.length === 0) slotsDiv.innerHTML = '<small class="w-100 text-center text-danger">Sem horários.</small>';
        
        times.forEach(t => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-dark btn-sm';
            btn.innerText = t;
            btn.onclick = () => {
                document.querySelectorAll('#slots button').forEach(b => b.classList.replace('btn-dark','btn-outline-dark'));
                btn.classList.replace('btn-outline-dark','btn-dark');
                document.getElementById('time').value = t;
                document.getElementById('btn').disabled = false;
            };
            slotsDiv.appendChild(btn);
        });
    });
</script>
{% endblock %}