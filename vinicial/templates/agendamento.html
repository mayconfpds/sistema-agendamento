{% extends 'layout.html' %}

{% block title %}Agendar {{ service.name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 rounded-3">
            <div class="card-body p-4 p-md-5">
                <h1 class="card-title h3 mb-1">Agendar Serviço</h1>
                <p class="text-muted mb-4">
                    {{ service.name }} (Duração: {{ service.duration }} minutos)
                </p>
                
                <form id="scheduleForm" action="{{ url_for('create_appointment') }}" method="POST">
                    <input type="hidden" name="service_id" value="{{ service.id }}">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="client_name" class="form-label fw-semibold">Seu Nome Completo</label>
                            <input type="text" class="form-control" id="client_name" name="client_name" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="appointment_date" class="form-label fw-semibold">Escolha a Data</label>
                            <input type="date" class="form-control" id="appointment_date" name="appointment_date" required>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-semibold">Escolha o Horário</label>
                            <div id="time-slots-container" class="border rounded-3 p-3 bg-light" style="min-height: 100px;">
                                <p id="time-slots-placeholder" class="text-muted mb-0">Por favor, selecione uma data para ver os horários disponíveis.</p>
                                <div id="time-slots" class="d-flex flex-wrap gap-2"></div>
                            </div>
                            <input type="hidden" id="appointment_time" name="appointment_time" required>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <button type="submit" id="submit-button" class="btn btn-primary btn-lg w-100 fw-semibold" disabled>Finalizar Agendamento</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('appointment_date');
    const timeSlotsDiv = document.getElementById('time-slots');
    const timeSlotsPlaceholder = document.getElementById('time-slots-placeholder');
    const hiddenTimeInput = document.getElementById('appointment_time');
    const submitButton = document.getElementById('submit-button');
    const serviceId = '{{ service.id }}';

    // Define a data mínima como hoje
    const today = new Date().toISOString().split('T')[0];
    dateInput.setAttribute('min', today);

    dateInput.addEventListener('change', function() {
        const selectedDate = this.value;
        timeSlotsDiv.innerHTML = '';
        hiddenTimeInput.value = '';
        submitButton.disabled = true;

        if (!selectedDate) {
            timeSlotsPlaceholder.textContent = 'Por favor, selecione uma data para ver os horários disponíveis.';
            timeSlotsPlaceholder.style.display = 'block';
            return;
        }

        timeSlotsPlaceholder.textContent = 'Carregando horários...';
        timeSlotsPlaceholder.style.display = 'block';

        fetch(`/api/horarios_disponiveis?service_id=${serviceId}&date=${selectedDate}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Falha na rede');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    timeSlotsPlaceholder.textContent = `Erro: ${data.error}`;
                    return;
                }
                
                if (data.length === 0) {
                    timeSlotsPlaceholder.textContent = 'Nenhum horário disponível para esta data. Por favor, tente outro dia.';
                } else {
                    timeSlotsPlaceholder.style.display = 'none';
                    data.forEach(time => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'btn btn-outline-primary time-slot-btn';
                        button.textContent = time;
                        button.dataset.time = time;
                        timeSlotsDiv.appendChild(button);
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao buscar horários:', error);
                timeSlotsPlaceholder.textContent = 'Não foi possível carregar os horários. Tente novamente.';
            });
    });

    timeSlotsDiv.addEventListener('click', function(e) {
        if (e.target.classList.contains('time-slot-btn')) {
            // Remove a classe 'active' de todos os botões
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.replace('btn-primary', 'btn-outline-primary');
            });
            // Adiciona a classe 'active' ao botão clicado
            e.target.classList.add('active');
            e.target.classList.replace('btn-outline-primary', 'btn-primary');
            
            hiddenTimeInput.value = e.target.dataset.time;
            submitButton.disabled = false;
        }
    });
});
</script>
{% endblock %}