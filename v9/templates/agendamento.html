{% extends 'layout.html' %}
{% block title %}Agendar{% endblock %}
{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 p-4">
                <div class="text-center mb-4">
                    {% if establishment.logo_filename %}
                        <img src="{{ url_for('static', filename='uploads/' + establishment.logo_filename) }}" class="rounded-circle shadow-sm mb-2" style="width: 60px; height: 60px; object-fit: cover;">
                    {% endif %}
                    <h4 class="fw-bold">{{ establishment.name }}</h4>
                    <h5 class="text-muted">{{ service.name }}</h5>
                    <p class="text-success fw-bold">Valor: R$ {{ "%.2f"|format(service.price) }}</p>
                </div>
                <form id="form" method="POST" action="{{ url_for('create_appointment', url_prefix=establishment.url_prefix) }}">
                    <input type="hidden" name="service_id" value="{{ service.id }}">
                    <div class="mb-2"><label class="fw-bold small">Seu Nome</label><input type="text" name="client_name" class="form-control" required></div>
                    <div class="mb-3"><label class="fw-bold small">Seu WhatsApp</label><input type="tel" name="client_phone" class="form-control" required></div>
                    <div class="mb-3"><label class="fw-bold small">Data</label><input type="date" id="date" name="appointment_date" class="form-control" required></div>
                    <div class="mb-4">
                        <label class="fw-bold small">Horários Disponíveis</label>
                        <div id="slots" class="d-flex flex-wrap gap-2 mt-2"><small class="text-muted">Selecione a data...</small></div>
                        <input type="hidden" id="time" name="appointment_time" required>
                    </div>
                    <button id="btn" class="btn btn-primary w-100 fw-bold" disabled>Confirmar Agendamento</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.getElementById('date').min = new Date().toISOString().split('T')[0];
document.getElementById('date').addEventListener('change', async (e) => {
    if(!e.target.value) return;
    const div = document.getElementById('slots');
    div.innerHTML = 'Carregando...';
    const res = await fetch(`/api/horarios_disponiveis?service_id={{ service.id }}&date=${e.target.value}`);
    const times = await res.json();
    div.innerHTML = '';
    if(times.length === 0) div.innerHTML = '<span class="text-danger small">Indisponível.</span>';
    times.forEach(t => {
        const b = document.createElement('button');
        b.type='button'; b.className='btn btn-outline-dark btn-sm'; b.innerText=t;
        b.onclick = () => {
            document.querySelectorAll('#slots button').forEach(x=>x.classList.replace('btn-dark','btn-outline-dark'));
            b.classList.replace('btn-outline-dark','btn-dark');
            document.getElementById('time').value=t;
            document.getElementById('btn').disabled=false;
        };
        div.appendChild(b);
    });
});
</script>
{% endblock %}