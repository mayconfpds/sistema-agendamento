{% extends 'layout.html' %}

{% block title %}Agendar {{ service.name }} - {{ establishment.name }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <a href="{{ url_for('establishment_services', url_prefix=establishment.url_prefix) }}" class="text-decoration-none mb-3 d-inline-block">
                <i class="bi bi-arrow-left"></i> Voltar para serviços
            </a>
            
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body p-4 p-md-5">
                    <div class="text-center mb-4">
                        <h2 class="h4 text-muted">{{ establishment.name }}</h2>
                        <h1 class="card-title h3 mb-1">Agendar {{ service.name }}</h1>
                        <span class="badge bg-light text-dark border">{{ service.duration }} min</span>
                    </div>
                    
                    <form id="scheduleForm" action="{{ url_for('create_appointment', url_prefix=establishment.url_prefix) }}" method="POST">
                        <input type="hidden" name="service_id" value="{{ service.id }}">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="client_name" class="form-label fw-semibold">Seu Nome Completo</label>
                                <input type="text" class="form-control" id="client_name" name="client_name" placeholder="Ex: Maria Silva" required>
                            </div>

                            <!-- NOVO CAMPO: TELEFONE -->
                            <div class="col-md-6">
                                <label for="client_phone" class="form-label fw-semibold">WhatsApp / Celular</label>
                                <input type="tel" class="form-control" id="client_phone" name="client_phone" placeholder="(XX) 9XXXX-XXXX" required>
                            </div>
                            
                            <div class="col-md-12">
                                <label for="appointment_date" class="form-label fw-semibold">Escolha a Data</label>
                                <input type="date" class="form-control" id="appointment_date" name="appointment_date" required>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-semibold">Escolha o Horário</label>
                                <div id="time-slots-container" class="border rounded-3 p-3 bg-light" style="min-height: 100px;">
                                    <p id="time-slots-placeholder" class="text-muted mb-0 text-center">Selecione uma data acima para ver os horários.</p>
                                    <div id="time-slots" class="d-flex flex-wrap gap-2 justify-content-center"></div>
                                </div>
                                <input type="hidden" id="appointment_time" name="appointment_time" required>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <button type="submit" id="submit-button" class="btn btn-primary btn-lg w-100 fw-semibold" disabled>Confirmar Agendamento</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('appointment_date');
    const timeSlotsDiv = document.getElementById('time-slots');
    const timeSlotsPlaceholder = document.getElementById('time-slots-placeholder');
    const hiddenTimeInput = document.getElementById('appointment_time');
    const submitButton = document.getElementById('submit-button');
    const serviceId = '{{ service.id }}';

    // Bloqueia datas passadas
    const today = new Date().toISOString().split('T')[0];
    dateInput.setAttribute('min', today);

    // Carrega horários ao mudar data
    dateInput.addEventListener('change', function() {
        const selectedDate = this.value;
        timeSlotsDiv.innerHTML = '';
        hiddenTimeInput.value = '';
        submitButton.disabled = true;

        if (!selectedDate) return;

        timeSlotsPlaceholder.textContent = 'Buscando horários...';
        timeSlotsPlaceholder.style.display = 'block';

        fetch(`/api/horarios_disponiveis?service_id=${serviceId}&date=${selectedDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    timeSlotsPlaceholder.textContent = data.error;
                    return;
                }
                
                if (data.length === 0) {
                    timeSlotsPlaceholder.textContent = 'Agenda cheia para este dia.';
                } else {
                    timeSlotsPlaceholder.style.display = 'none';
                    data.forEach(time => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'btn btn-outline-primary time-slot-btn';
                        button.textContent = time;
                        button.dataset.time = time;
                        timeSlotsDiv.appendChild(button);
                    });
                }
            })
            .catch(error => {
                console.error(error);
                timeSlotsPlaceholder.textContent = 'Erro ao carregar horários.';
            });
    });

    // Seleção visual do horário
    timeSlotsDiv.addEventListener('click', function(e) {
        if (e.target.classList.contains('time-slot-btn')) {
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            e.target.classList.add('active', 'btn-primary');
            e.target.classList.remove('btn-outline-primary');
            
            hiddenTimeInput.value = e.target.dataset.time;
            submitButton.disabled = false;
        }
    });
});
</script>
{% endblock %}